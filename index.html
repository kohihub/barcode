<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Scanner de Etiquetas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    #scanner { width: 100%; max-width: 400px; margin: auto; }
    .etiqueta { 
      border: 1px solid #aaa; 
      border-radius: 8px; 
      padding: 10px; 
      margin: 10px 0; 
      text-align: left; 
    }
    .campo { margin: 5px 0; }
    #lista { margin-top: 20px; }
    button { margin: 15px; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>
  <div id="scanner"></div>
  <button onclick="copiarDeviceIDs()">üìã Copiar DeviceIDs</button>
  <div id="lista"></div>

  <script>
    // --- Configura√ß√£o Firebase (substituir pelos teus dados) ---
  const firebaseConfig = {
    apiKey: "AIzaSyC2eUz5iTUURydrdi4So1uPmQs9esGFe_E",
    authDomain: "pitzi-cel-barcode.firebaseapp.com",
    projectId: "pitzi-cel-barcode",
    storageBucket: "pitzi-cel-barcode.firebasestorage.app",
    messagingSenderId: "196032039906",
    appId: "1:196032039906:web:1bc78ed983bbb7b07387bb"
  };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let buffer = {};        // Guarda leituras da etiqueta atual
    let bloqueado = false;  // Evita m√∫ltiplas leituras muito r√°pidas

    // --- Fun√ß√£o para criar div da etiqueta ---
    function criarEtiqueta(dados) {
      const div = document.createElement("div");
      div.className = "etiqueta";
      div.innerHTML = `
        <div class="campo"><b>IMEI:</b> ${dados.imei || "-"}</div>
        <div class="campo"><b>DeviceID:</b> ${dados.deviceid || "-"}</div>
        <div class="campo"><b>ProductID:</b> ${dados.productid || "-"}</div>
        <div class="campo"><b>SRID:</b> ${dados.srid || "-"}</div>
      `;
      document.getElementById("lista").prepend(div);
    }

    // --- Detecta tipo de c√≥digo pelo tamanho ---
    function classificarCodigo(code) {
      if (/^\d{15}$/.test(code)) return "imei";
      if (/^\d{7}$/.test(code))  return "deviceid";
      if (/^\d{4}$/.test(code))  return "productid";
      if (/^\d{5}$/.test(code))  return "srid";
      return null;
    }

    // --- Processa c√≥digo lido ---
    function processarCodigo(code) {
      const tipo = classificarCodigo(code);
      if (!tipo) return;

      buffer[tipo] = code;
      console.log("Leu:", tipo, code);

      // Se j√° leu todos os 4 ‚Üí cria a etiqueta
      if (buffer.imei && buffer.deviceid && buffer.productid && buffer.srid) {
        const dados = { ...buffer, timestamp: firebase.firestore.FieldValue.serverTimestamp() };

        // Salva no Firestore
        db.collection("codigos").add(dados)
          .then(() => console.log("Etiqueta salva:", dados))
          .catch(err => console.error("Erro Firestore:", err));

        // Mostra no navegador
        criarEtiqueta(buffer);

        buffer = {}; // limpa para pr√≥xima
        bloqueado = true;
        setTimeout(() => bloqueado = false, 1000); // 1s de delay
      }
    }

    // --- Escuta Firestore em tempo real ---
    db.collection("codigos").orderBy("timestamp", "desc")
      .onSnapshot(snapshot => {
        document.getElementById("lista").innerHTML = "";
        snapshot.forEach(doc => {
          criarEtiqueta(doc.data());
        });
      });

    // --- Inicia Quagga (scanner) ---
    if (navigator.mediaDevices) {
      Quagga.init({
        inputStream: {
          type: "LiveStream",
          constraints: { facingMode: "environment" },
          target: document.querySelector('#scanner')
        },
        decoder: { readers: ["code_128_reader","ean_reader","ean_8_reader","code_39_reader"] }
      }, function(err) {
        if (!err) Quagga.start();
      });

      Quagga.onDetected((data) => {
        if (bloqueado) return;
        processarCodigo(data.codeResult.code);
      });
    }

    // --- Copiar s√≥ os DeviceID ---
    function copiarDeviceIDs() {
      const divs = document.querySelectorAll(".etiqueta .campo:nth-child(2)");
      let ids = [];
      divs.forEach(d => {
        ids.push(d.innerText.replace("DeviceID:", "").trim());
      });
      navigator.clipboard.writeText(ids.join("\n"))
        .then(() => alert("DeviceIDs copiados!"))
        .catch(err => alert("Erro ao copiar: " + err));
    }
  </script>
</body>
</html>
